// ============================================================================
// VertrouwdBouwen - Escrow Platform Prisma Schema
// ============================================================================
// PostgreSQL database schema voor het escrow platform
// Verbindt klanten met aannemers voor bouwprojecten
// ============================================================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x"]
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// User roles: CUSTOMER, CONTRACTOR, ADMIN
enum UserRole {
  CUSTOMER
  CONTRACTOR
  ADMIN
}

// Project statuses
enum ProjectStatus {
  DRAFT
  PENDING_CONTRACTOR
  ACTIVE
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

// Milestone statuses
enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
  PAID
}

// Escrow payment statuses (voor legacy EscrowPayment model)
enum PaymentStatus {
  PENDING
  HELD
  RELEASED
  REFUNDED
}

// Project payment status (voor project-level escrow)
enum ProjectPaymentStatus {
  NOT_FUNDED
  PARTIALLY_FUNDED
  FULLY_FUNDED
}

// Project payment direction
enum ProjectPaymentDirection {
  INCOMING  // Consument betaalt naar escrow
  OUTGOING  // Uitbetaling aan aannemer (via Payout model)
}

// Project payment status (voor inkomende escrow betalingen)
enum ProjectPaymentStatusEnum {
  PENDING_CONSUMER        // Consument heeft betaling geïnitieerd maar nog niet voltooid (optioneel)
  PENDING_ADMIN_REVIEW    // Consument zegt betaald te hebben, admin moet controleren
  ESCROW_CONFIRMED        // Admin heeft betaling goedgekeurd, geld staat in escrow
  REJECTED                // Admin heeft betaling afgewezen
}

// Payout status (voor uitbetalingen aan aannemers)
enum PayoutStatus {
  PENDING_ADMIN_PAYOUT    // Milestone goedgekeurd, wacht op admin uitbetaling
  PAID                    // Admin heeft uitbetaald
}

// Approval statuses
enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// Dispute statuses
enum DisputeStatus {
  OPEN
  RESOLVED
  CLOSED
}

// Notification types
enum NotificationType {
  PROJECT_CREATED      // Nieuw project aangemaakt en gekoppeld aan aannemer
  PROJECT_ACCEPTED    // Project geaccepteerd door aannemer
  MILESTONE_SUBMITTED // Milestone ingediend door aannemer
  MILESTONE_APPROVED  // Milestone goedgekeurd
  PAYMENT_RECEIVED    // Betaling ontvangen
  DISPUTE_OPENED     // Geschil geopend
}

// Notification read status
enum NotificationReadStatus {
  UNREAD
  READ
}

// ============================================================================
// USER MODEL
// ============================================================================
// Gebruikers van het platform: klanten, aannemers en admins
// Klanten kunnen projecten aanmaken, aannemers kunnen projecten accepteren
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  companyName  String?  @map("company_name") // Verplicht voor CONTRACTOR
  kvkNumber    String?  @map("kvk_number")   // KVK nummer voor aannemers
  phone        String?  // Optioneel telefoonnummer
  address      Json?    // Flexibel JSON object voor adresgegevens
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  customerProjects  Project[] @relation("CustomerProjects")
  contractorProjects Project[] @relation("ContractorProjects")
  approvals         Approval[]
  sentMessages      Message[]  @relation("SentMessages")
  initiatedDisputes Dispute[]  @relation("InitiatorDisputes")
  projectPayments   ProjectPayment[] @relation("ConsumerPayments") // Betalingen die consument heeft gedaan
  payouts           Payout[]         @relation("ContractorPayouts") // Uitbetalingen die aannemer heeft ontvangen
  notifications     Notification[]  // Notificaties voor deze gebruiker

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

// ============================================================================
// PROJECT MODEL
// ============================================================================
// Projecten die klanten met aannemers verbinden
// Status flow: DRAFT → PENDING_CONTRACTOR → ACTIVE → IN_PROGRESS → COMPLETED
// ============================================================================

model Project {
  id                String              @id @default(uuid())
  customerId        String              @map("customer_id")
  contractorId      String?             @map("contractor_id") // Null tot acceptatie door aannemer
  title             String
  description       String
  totalBudget       Decimal             @map("total_budget") @db.Decimal(10, 2)
  status            ProjectStatus       @default(DRAFT)
  paymentStatus     ProjectPaymentStatus @default(NOT_FUNDED) @map("payment_status")
  escrowFundedAmount Decimal            @default(0) @map("escrow_funded_amount") @db.Decimal(10, 2) // Huidige saldo op escrow voor dit project
  startDate         DateTime?           @map("start_date") @db.Date
  endDate           DateTime?           @map("end_date") @db.Date
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  customer          User                @relation("CustomerProjects", fields: [customerId], references: [id], onDelete: Restrict)
  contractor        User?               @relation("ContractorProjects", fields: [contractorId], references: [id], onDelete: SetNull)
  milestones        Milestone[]
  messages          Message[]
  disputes          Dispute[]
  projectPayments   ProjectPayment[]    // Inkomende escrow betalingen
  payouts           Payout[]            // Uitbetalingen aan aannemers
  notifications     Notification[]     // Notificaties voor dit project

  @@index([customerId])
  @@index([contractorId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("projects")
}

// ============================================================================
// MILESTONE MODEL
// ============================================================================
// Project fasen met specifieke bedragen en deadlines
// Status flow: PENDING → IN_PROGRESS → SUBMITTED → APPROVED → PAID
// Elke milestone heeft een volgorde (order) binnen het project
// ============================================================================

model Milestone {
  id                  String          @id @default(uuid())
  projectId           String          @map("project_id")
  title               String
  description         String
  amount              Decimal         @db.Decimal(10, 2) // Bedrag in euro
  status              MilestoneStatus @default(PENDING)
  order               Int             // Volgorde binnen project (1, 2, 3, ...)
  dueDate             DateTime?       @map("due_date") @db.Date
  approvedByConsumer   Boolean         @default(false) @map("approved_by_consumer")
  approvedByContractor Boolean         @default(false) @map("approved_by_contractor")
  requiresConsumerAction Boolean       @default(false) @map("requires_consumer_action") // True wanneer aannemer milestone heeft ingediend en consument actie moet ondernemen
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  // Relations
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  payments    EscrowPayment[]
  approvals   Approval[]
  disputes    Dispute[]
  payout      Payout?         // Optionele payout voor deze milestone (max 1 per milestone)

  @@unique([projectId, order]) // Unieke combinatie van project en volgorde
  @@index([projectId])
  @@index([status])
  @@index([projectId, order])
  @@map("milestones")
}

// ============================================================================
// ESCROW PAYMENT MODEL
// ============================================================================
// Escrow betalingen voor milestones
// Status flow: PENDING → HELD → RELEASED (bij goedkeuring) of REFUNDED
// Geld wordt in escrow gehouden tot goedkeuring door klant
// ============================================================================

model EscrowPayment {
  id                String        @id @default(uuid())
  milestoneId       String        @map("milestone_id")
  amount            Decimal       @db.Decimal(10, 2) // Bedrag in escrow
  status            PaymentStatus @default(PENDING)
  heldAt            DateTime?     @map("held_at")     // Wanneer geld in escrow gezet
  releasedAt        DateTime?     @map("released_at") // Wanneer geld vrijgegeven
  transactionRef    String        @unique @map("transaction_reference") // Unieke transactie ID
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  milestone         Milestone     @relation(fields: [milestoneId], references: [id], onDelete: Restrict)

  @@index([milestoneId])
  @@index([status])
  @@index([transactionRef])
  @@index([heldAt])
  @@map("escrow_payments")
}

// ============================================================================
// APPROVAL MODEL
// ============================================================================
// Goedkeuringen van milestones door klanten
// Status: PENDING → APPROVED of REJECTED
// Bij goedkeuring wordt betaling vrijgegeven, bij afwijzing blijft geld in escrow
// ============================================================================

model Approval {
  id          String          @id @default(uuid())
  milestoneId String          @map("milestone_id")
  approverId  String          @map("approver_id") // ID van de klant die goedkeurt
  status      ApprovalStatus  @default(PENDING)
  comments    String?         // Optionele opmerkingen van klant
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  milestone   Milestone       @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  approver    User            @relation(fields: [approverId], references: [id], onDelete: Restrict)

  @@index([milestoneId])
  @@index([approverId])
  @@index([status])
  @@index([createdAt])
  @@map("approvals")
}

// ============================================================================
// MESSAGE MODEL
// ============================================================================
// Berichten tussen klant en aannemer binnen een project
// Gebruikt voor communicatie over project voortgang
// ============================================================================

model Message {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  senderId  String   @map("sender_id")
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Restrict)

  @@index([projectId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================================================
// DISPUTE MODEL
// ============================================================================
// Geschillen over projecten of specifieke milestones
// Status: OPEN → RESOLVED → CLOSED
// milestoneId is optioneel: null = geschil over hele project
// ============================================================================

model Dispute {
  id          String        @id @default(uuid())
  projectId   String        @map("project_id")
  milestoneId String?       @map("milestone_id") // Null als geschil over hele project
  initiatorId String        @map("initiator_id")  // Wie heeft geschil gestart
  reason      String        // Reden voor geschil
  status      DisputeStatus @default(OPEN)
  resolution  String?       // Oplossing (bij RESOLVED status)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone   Milestone?    @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  initiator   User          @relation("InitiatorDisputes", fields: [initiatorId], references: [id], onDelete: Restrict)

  @@index([projectId])
  @@index([milestoneId])
  @@index([initiatorId])
  @@index([status])
  @@map("disputes")
}

// ============================================================================
// PROJECT PAYMENT MODEL
// ============================================================================
// Inkomende escrow betalingen van consument naar project
// Status flow: PENDING_ADMIN_REVIEW → ESCROW_CONFIRMED (of REJECTED)
// Admin moet betaling controleren en goedkeuren voordat geld in escrow staat
// ============================================================================

model ProjectPayment {
  id                String                    @id @default(uuid())
  projectId         String                    @map("project_id")
  consumerId        String                    @map("consumer_id")
  amount            Decimal                   @db.Decimal(10, 2)
  direction         ProjectPaymentDirection   @default(INCOMING)
  status            ProjectPaymentStatusEnum  @default(PENDING_ADMIN_REVIEW) @map("status")
  transactionRef    String?                  @unique @map("transaction_reference") // Externe transactie referentie (optioneel)
  adminNotes        String?                   @map("admin_notes") // Notities van admin bij review
  confirmedAt       DateTime?                 @map("confirmed_at") // Wanneer admin heeft goedgekeurd
  confirmedBy       String?                   @map("confirmed_by") // Admin ID die heeft goedgekeurd
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")

  // Relations
  project           Project                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  consumer          User                      @relation("ConsumerPayments", fields: [consumerId], references: [id], onDelete: Restrict)

  @@index([projectId])
  @@index([consumerId])
  @@index([status])
  @@index([transactionRef])
  @@index([createdAt])
  @@map("project_payments")
}

// ============================================================================
// PAYOUT MODEL
// ============================================================================
// Uitbetalingen aan aannemers na milestone completion
// Status flow: PENDING_ADMIN_PAYOUT → PAID
// Wordt automatisch aangemaakt wanneer milestone door beide partijen is goedgekeurd
// Admin moet payout markeren als PAID na daadwerkelijke uitbetaling
// ============================================================================

model Payout {
  id                String        @id @default(uuid())
  projectId         String        @map("project_id")
  milestoneId       String        @unique @map("milestone_id") // Unique voor one-to-one relatie met Milestone
  contractorId      String        @map("contractor_id")
  amount            Decimal       @db.Decimal(10, 2)
  status            PayoutStatus  @default(PENDING_ADMIN_PAYOUT)
  transactionRef    String?       @unique @map("transaction_reference") // Externe transactie referentie (optioneel)
  adminNotes        String?       @map("admin_notes") // Notities van admin bij uitbetaling
  requestedAt       DateTime      @default(now()) @map("requested_at") // Wanneer payout request is aangemaakt
  paidAt            DateTime?     @map("paid_at") // Wanneer admin heeft uitbetaald
  paidBy            String?       @map("paid_by") // Admin ID die heeft uitbetaald
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  project           Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone         Milestone     @relation(fields: [milestoneId], references: [id], onDelete: Restrict)
  contractor        User          @relation("ContractorPayouts", fields: [contractorId], references: [id], onDelete: Restrict)

  @@index([projectId])
  @@index([contractorId])
  @@index([status])
  @@index([transactionRef])
  @@index([requestedAt])
  @@map("payouts")
}

// ============================================================================
// NOTIFICATION MODEL
// ============================================================================
// Notificaties voor gebruikers over belangrijke gebeurtenissen
// Bijvoorbeeld: nieuw project gekoppeld, milestone ingediend, etc.
// ============================================================================

model Notification {
  id          String                @id @default(uuid())
  userId      String                @map("user_id") // Gebruiker die de notificatie ontvangt
  projectId   String?               @map("project_id") // Optioneel: project waar notificatie over gaat
  type        NotificationType      // Type notificatie
  title       String                // Titel van de notificatie
  message     String                // Bericht van de notificatie
  readStatus  NotificationReadStatus @default(UNREAD) @map("read_status")
  readAt      DateTime?             @map("read_at") // Wanneer notificatie is gelezen
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  // Relations
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project?              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([readStatus])
  @@index([createdAt])
  @@index([userId, readStatus]) // Voor efficiënt ophalen van ongelezen notificaties
  @@map("notifications")
}

