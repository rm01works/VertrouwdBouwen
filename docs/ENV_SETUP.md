# Environment Variables Setup Guide

## Overview

This document describes the **minimal, canonical** environment variable setup for the VertrouwdBouwen platform on Vercel + Neon.

---

## Required Environment Variables

### For API Backend (`apps/api`)

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `DATABASE_URL` | **Secret** | Neon PostgreSQL connection string | `postgres://user:pass@host.neon.tech/db?sslmode=require` |
| `JWT_SECRET` | **Secret** | Secret key for JWT token signing | `random-secure-string-32-chars-min` |

### For Web Frontend (`apps/web`)

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `NEXT_PUBLIC_API_URL` | **Plain Text** | URL to Express API backend | `https://your-api.vercel.app` |

---

## Optional Environment Variables

### API Backend

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `NODE_ENV` | Plain Text | `development` | Environment mode |
| `PORT` | Plain Text | `5001` | Server port |
| `JWT_EXPIRES_IN` | Plain Text | `7d` | JWT expiration time |
| `CORS_ORIGIN` | Plain Text | `http://localhost:3000` | Allowed CORS origins |
| `SHADOW_DATABASE_URL` | Secret | - | Shadow DB for migrations (usually not needed) |

---

## DATABASE_URL Format

### For Neon PostgreSQL (Production)

```
postgres://USER:PASSWORD@HOST.neon.tech/DBNAME?sslmode=require
```

**Important:**
- ✅ Use `postgres://` (not `postgresql://`)
- ✅ Always include `?sslmode=require`
- ❌ Remove `channel_binding=require` if present (Prisma doesn't support it)
- ❌ Don't include `schema=public` (Neon handles this automatically)

### For Local PostgreSQL (Development)

```
postgresql://user:password@localhost:5432/dbname?schema=public
```

**Note:** Local development uses `postgresql://` (with `ql`).

---

## JWT_SECRET Generation

Generate a secure random secret:

```bash
openssl rand -base64 32
```

**Requirements:**
- Minimum 32 characters
- Use a unique value for production
- Never commit to version control

---

## Vercel Configuration

### Setting Environment Variables in Vercel

1. Go to your Vercel project → **Settings** → **Environment Variables**
2. Add each variable with the appropriate scope:
   - **Production**: Live production environment
   - **Preview**: Preview deployments (PRs, branches)
   - **Development**: Local development (optional)

### Required Variables for Each Environment

#### Production Environment

```bash
# API Backend
DATABASE_URL=postgres://user:pass@host.neon.tech/db?sslmode=require
JWT_SECRET=your-production-secret-key
NODE_ENV=production

# Web Frontend
NEXT_PUBLIC_API_URL=https://your-api.vercel.app
```

#### Preview Environment

```bash
# API Backend (can use same or separate Neon database)
DATABASE_URL=postgres://user:pass@host.neon.tech/db?sslmode=require
JWT_SECRET=your-preview-secret-key
NODE_ENV=production

# Web Frontend
NEXT_PUBLIC_API_URL=https://your-api-preview.vercel.app
```

#### Development Environment (Local)

Create `.env.local` in `apps/api/` and `apps/web/`:

```bash
# apps/api/.env.local
DATABASE_URL=postgresql://user:password@localhost:5432/dbname?schema=public
JWT_SECRET=local-dev-secret-key
NODE_ENV=development
PORT=5001

# apps/web/.env.local
NEXT_PUBLIC_API_URL=http://localhost:5001
```

---

## Unused Environment Variables (Safe to Delete)

The following environment variables are **NOT used** in the codebase and can be safely deleted from Vercel:

### Database-Related (Unused)

- ❌ `DATABASE_URL_UNPOOLED`
- ❌ `NEON_PROJECT_ID`
- ❌ `PGDATABASE`
- ❌ `PGHOST`
- ❌ `PGHOST_UNPOOLED`
- ❌ `PGPASSWORD`
- ❌ `PGUSER`
- ❌ `POSTGRES_DATABASE`
- ❌ `POSTGRES_HOST`
- ❌ `POSTGRES_PASSWORD`
- ❌ `POSTGRES_PRISMA_URL`
- ❌ `POSTGRES_URL`
- ❌ `POSTGRES_URL_NON_POOLING`
- ❌ `POSTGRES_URL_NO_SSL`
- ❌ `POSTGRES_USER`

### Other (Unused)

- ❌ `VERCEL_OIDC_TOKEN` (if not used for other purposes)

**Note:** These variables may have been auto-generated by Neon integrations or templates. They are not referenced anywhere in the codebase.

---

## Validation

The application validates required environment variables at runtime:

- ✅ Missing `DATABASE_URL` → Clear error message
- ✅ Missing `JWT_SECRET` → Clear error message
- ✅ Invalid `DATABASE_URL` format → Warning logged

**Error messages will guide you to configure the missing variables in Vercel.**

---

## Quick Setup Checklist

### For Vercel Production

- [ ] Set `DATABASE_URL` (Secret) in Vercel → Production
- [ ] Set `JWT_SECRET` (Secret) in Vercel → Production
- [ ] Set `NEXT_PUBLIC_API_URL` (Plain Text) in Vercel → Production
- [ ] Set `NODE_ENV=production` (Plain Text) in Vercel → Production
- [ ] Delete unused environment variables (see list above)

### For Vercel Preview

- [ ] Set `DATABASE_URL` (Secret) in Vercel → Preview
- [ ] Set `JWT_SECRET` (Secret) in Vercel → Preview
- [ ] Set `NEXT_PUBLIC_API_URL` (Plain Text) in Vercel → Preview
- [ ] Set `NODE_ENV=production` (Plain Text) in Vercel → Preview

### For Local Development

- [ ] Copy `apps/api/.env.example` to `apps/api/.env.local`
- [ ] Copy `apps/web/.env.example` to `apps/web/.env.local` (if exists)
- [ ] Fill in local database connection string
- [ ] Generate and set `JWT_SECRET`

---

## Troubleshooting

### "DATABASE_URL is not set"

1. Check Vercel project settings → Environment Variables
2. Ensure variable is set for the correct environment (Production/Preview)
3. Redeploy after adding variables

### "JWT_SECRET is not set"

1. Generate a new secret: `openssl rand -base64 32`
2. Add to Vercel → Environment Variables → Secret
3. Redeploy

### Empty 500 Error on Registration

1. Check Vercel function logs for detailed error messages
2. Verify `DATABASE_URL` is correctly formatted
3. Verify `JWT_SECRET` is set
4. Check Neon database is accessible (not paused)

---

## Related Documentation

- [Neon Clean Slate Setup](./NEON_CLEAN_SLATE_SETUP.md) - Setting up a fresh Neon database
- [Vercel Deployment Guide](./VERCEL_DEPLOYMENT_QUICKSTART.md) - Full deployment walkthrough
- [Prisma Setup](./NEON_PRISMA_SETUP.md) - Prisma + Neon configuration

